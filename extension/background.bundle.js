"use strict";(()=>{var f="https://ebsegrbkrmbundqhrvfc.supabase.co/",g="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImVic2VncmJrcm1idW5kcWhydmZjIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTA3NjI5MjMsImV4cCI6MjA2NjMzODkyM30.K9FpAtr06HCdmVFHl-SOWho6Fgi77klCUjaWJmRHv6A",u=w(f,g,{auth:{autoRefreshToken:!0,persistSession:!0,detectSessionInUrl:!1}});function w(t,e,a){return{auth:{getSession:async()=>{try{let r=await fetch(`${t}/auth/v1/user`,{headers:{apikey:e,Authorization:`Bearer ${await m()}`}});return r.ok?{data:{session:{user:await r.json()}},error:null}:{data:{session:null},error:null}}catch(r){return{data:{session:null},error:r}}}},from:r=>({insert:i=>({select:()=>({then:async n=>{try{let o=await m(),l=await fetch(`${t}/rest/v1/${r}`,{method:"POST",headers:{apikey:e,Authorization:`Bearer ${o}`,"Content-Type":"application/json",Prefer:"return=representation"},body:JSON.stringify(i)}),d=await l.json();n({data:d,error:l.ok?null:d})}catch(o){n({data:null,error:o})}}})})})}}async function m(){return(await chrome.storage.local.get(["hoarder_auth_token"])).hoarder_auth_token}function c(t){let e=t.toLowerCase();return e.includes("twitter.com")||e.includes("x.com")?"twitter":e.includes("linkedin.com")?"linkedin":e.includes("reddit.com")?"reddit":e.includes("tiktok.com")?"tiktok":e.includes("youtube.com")||e.includes("youtu.be")?"youtube":"web"}function h(t){try{let e=new URL(t),a=c(t),r="",i=e.pathname.split("/").filter(Boolean);if(a==="twitter")i.length>=2?r=`Tweet by @${i[0]}`:r="Twitter Post";else if(a==="linkedin")r="LinkedIn Post";else if(a==="reddit")i.length>=3?r=decodeURIComponent(i[2]).replace(/[-_]/g," "):r="Reddit Post";else if(a==="tiktok")r="TikTok Video";else if(a==="youtube")r="YouTube Video";else if(i.length>0){let n=i[i.length-1];r=decodeURIComponent(n).replace(/[-_]/g," "),r=r.charAt(0).toUpperCase()+r.slice(1)}else r=e.hostname.replace("www.","");return{title:r,platform:a}}catch{return{title:"Unknown",platform:"web"}}}async function p(t){let e=h(t),a=e.platform||"web";if(a==="twitter")return e;try{let r=await fetch(`https://api.microlink.io/?url=${encodeURIComponent(t)}`),{data:i}=await r.json();return{title:i.title||e.title||"Unknown",description:i.description||void 0,image:i.image?.url||void 0,platform:a}}catch(r){console.error("Error fetching metadata from Microlink:",r)}return{title:e.title||"Unknown",platform:a}}function k(t,e,a){let r=`${t} ${e||""}`.toLowerCase(),i=[];return["ai","artificial intelligence","machine learning","ml","react","javascript","typescript","python","node","startup","business","entrepreneur","funding","design","ux","ui","product","user experience","programming","coding","development","software","technology","tech","innovation","future","social media","marketing","growth","strategy","web3","blockchain","crypto","defi","mobile","app","ios","android","data","analytics","big data","database"].forEach(o=>{r.includes(o)&&!i.includes(o)&&i.push(o)}),(a==="twitter"||r.includes("twitter")||r.includes("tweet"))&&i.push("social media","twitter"),(a==="linkedin"||r.includes("linkedin"))&&i.push("professional","networking","business"),(a==="reddit"||r.includes("reddit"))&&i.push("community","discussion","reddit"),(a==="tiktok"||r.includes("tiktok"))&&i.push("video","social media","tiktok"),(a==="youtube"||r.includes("youtube"))&&i.push("video","youtube","streaming"),(r.includes("thread")||r.includes("threads"))&&i.push("thread"),(r.includes("video")||r.includes("tutorial"))&&i.push("video"),(r.includes("article")||r.includes("blog"))&&i.push("article"),(r.includes("news")||r.includes("update"))&&i.push("news"),(r.includes("tutorial")||r.includes("guide"))&&i.push("tutorial"),i.slice(0,5)}async function y(t){try{let{data:e,error:a}=await u.from("bookmarks").insert([{url:t.url,title:t.title,description:t.description,image_url:t.imageUrl,platform:t.platform,tags:t.tags,source:"extension",user_id:t.userId}]).select();if(a)throw a;return{success:!0,data:e&&e[0]}}catch(e){throw console.error("Failed to save bookmark:",e),e}}async function b(){let[t]=await chrome.tabs.query({active:!0,currentWindow:!0});if(!t)throw new Error("No active tab found");try{let e=await chrome.tabs.sendMessage(t.id,{type:"GET_PAGE_METADATA"});if(e&&e.metadata)if(!e.metadata.description||!e.metadata.imageUrl){let a=await p(t.url);return{title:e.metadata.title||a.title||"Unknown",url:e.metadata.url,description:e.metadata.description||a.description||"",imageUrl:e.metadata.imageUrl||a.image||"",platform:e.metadata.platform||a.platform}}else return{title:e.metadata.title||"Unknown",url:e.metadata.url,description:e.metadata.description||"",imageUrl:e.metadata.imageUrl||"",platform:e.metadata.platform||c(e.metadata.url)}}catch{try{let a=await p(t.url);return{title:a.title||t.title||"Unknown",url:t.url,description:a.description||"",imageUrl:a.image||"",platform:a.platform||c(t.url)}}catch{let r=h(t.url);return{title:t.title||r.title||"Unknown",url:t.url,description:"",imageUrl:"",platform:r.platform}}}}async function U(t){try{let e=await b(),a=k(e.title,e.description,e.platform);return await y({...e,tags:a,userId:t})}catch(e){throw console.error("Error saving current page:",e),e}}chrome.runtime.onInstalled.addListener(t=>{t.reason==="install"&&console.log("Hoarder extension installed")});chrome.commands.onCommand.addListener(async t=>{switch(console.log("Command received:",t),t){case"save-bookmark":await v();break;case"open-popup":await A();break;default:console.log("Unknown command:",t)}});async function v(){try{let{data:{session:t}}=await u.auth.getSession();if(!t){await s("Please sign in to Hoarder first","Click the extension icon to sign in"),await chrome.action.openPopup(),setTimeout(()=>{chrome.runtime.sendMessage({type:"SHOW_BANNER",message:"Please sign in to Hoarder first",status:"error"})},500);return}(await U(t.user.id)).success?(await s("Bookmark saved!","Successfully saved to Hoarder"),await chrome.action.openPopup(),setTimeout(()=>{chrome.runtime.sendMessage({type:"SHOW_BANNER",message:"Bookmark saved!",status:"success"})},500)):(await s("Failed to save bookmark","Please try again"),await chrome.action.openPopup(),setTimeout(()=>{chrome.runtime.sendMessage({type:"SHOW_BANNER",message:"Failed to save bookmark",status:"error"})},500))}catch(t){console.error("Error saving bookmark from shortcut:",t),await s("Error saving bookmark",t.message),await chrome.action.openPopup(),setTimeout(()=>{chrome.runtime.sendMessage({type:"SHOW_BANNER",message:"Error saving bookmark",status:"error"})},500)}}async function A(){try{await chrome.action.openPopup()}catch(t){console.error("Error opening popup:",t)}}async function s(t,e){try{await chrome.notifications.create({type:"basic",iconUrl:"icons/icon48.png",title:t,message:e})}catch(a){console.error("Error showing notification:",a)}}chrome.runtime.onMessage.addListener((t,e,a)=>{switch(t.type){case"GET_CURRENT_TAB":return chrome.tabs.query({active:!0,currentWindow:!0},r=>{a({tab:r[0]})}),!0;case"SAVE_BOOKMARK":console.log("Save bookmark request:",t.data),a({success:!0});break;case"CHECK_AUTH":return u.auth.getSession().then(({data:{session:r}})=>{a({authenticated:!!r,user:r?.user})}),!0;default:a({error:"Unknown message type"})}});})();
